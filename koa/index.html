<!DOCTYPE html><html lang="zh-Hans"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta name="x5-fullscreen" content="true"><meta name="full-screen" content="yes"><meta name="theme-color" content="#317EFB"><meta content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=0" name="viewport"><meta name="description" content="前端Node，Node.js，node.js框架 Koa"><meta property="og:type" content="article"><meta property="og:title" content="Node.js 【Koa】"><meta property="og:url" content="https://www.yangchenyu.com/koa/index.html"><meta property="og:site_name" content="Cheny"><meta property="og:description" content="前端Node，Node.js，node.js框架 Koa"><meta property="og:locale"><meta property="article:published_time" content="2019-11-21T08:26:21.000Z"><meta property="article:modified_time" content="2023-06-09T08:25:14.006Z"><meta property="article:author" content="Cheny"><meta property="article:tag" content="Node.js"><meta name="twitter:card" content="summary"><meta name="keywords" content="前端Node，Node.js，node.js，Koa"><title>Node.js 【Koa】</title><link href="/favicon-16x16.png?v=1.2.14" rel="icon" type="image/png" sizes="16x16"><link href="/favicon-32x32.png?v=1.2.14" rel="icon" type="image/png" sizes="32x32"><link href="/apple-touch-icon.png?v=1.2.14" rel="apple-touch-icon" sizes="180x180"><link href="/site.webmanifest" rel="manifest"><link rel="stylesheet" href="/css/plugins/bootstrap.row.css"><link rel="stylesheet" href="https://unpkg.com/locomotive-scroll@4.1.4/dist/locomotive-scroll.min.css"><link rel="stylesheet" href="https://unpkg.com/@fancyapps/ui@4.0/dist/fancybox.css"><link rel="stylesheet" href="/css/plugins/font-awesome.min.css"><script>window.ASYNC_CONFIG={hostname:"www.yangchenyu.com",author:"Cheny",root:"/",typed_text:["Aspirant Developer"],favicon:{logo:"https://cheny-chenyu.oss-cn-chengdu.aliyuncs.com/img/blog-logo.png",icon16:"favicon-16x16.png",icon32:"favicon-32x32.png",appleTouchIcon:"apple-touch-icon.png",webmanifest:"/site.webmanifest",visibilitychange:!1,hidden:"/failure.ico",showText:"(/≧▽≦/)咦！又好了！",hideText:"(●—●)喔哟，崩溃啦！"},theme_version:"1.2.14",theme:{switch:!0,default:"auto"},search:{enable:!0,type:"local",href:"https://www.google.com/search?q=site:",domain:null,preload:!0,trigger:"auto",path:"search.xml"},i18n:{placeholder:"搜索...",empty:"找不到您查询的内容: ${query}",hits:"找到 ${hits} 条结果",hits_time:"找到 ${hits} 条结果（用时 ${time} 毫秒）",author:"本文作者：",copyright_link:"本文链接：",copyright_license_title:"版权声明：",copyright_license_content:"本博客所有文章除特别声明外，均默认采用 undefined 许可协议。",copy_button:"复制",copy_success:"复制成功",copy_failure:"复制失败",open_read_mode:"进入阅读模式",exit_read_mode:"退出阅读模式"},creative_commons:{license:"by-nc-sa",language:"deed.zh",post:!0,clipboard:!1},swup:!0,plugin:{flickr_justified_gallery:{js:"https://unpkg.com/flickr-justified-gallery@latest/dist/fjGallery.min.js"},fancybox:{css:"https://unpkg.com/@fancyapps/ui@4.0/dist/fancybox.css",js:"https://unpkg.com/@fancyapps/ui@4.0/dist/fancybox.umd.js"}},icons:{sun:"far fa-sun",moon:"far fa-moon",play:"fas fa-play",email:"far fa-envelope",next:"fas fa-arrow-right",calendar:"far fa-calendar-alt",clock:"far fa-clock",user:"far fa-user",back_top:"fas fa-arrow-up",close:"fas fa-times",search:"fas fa-search",reward:"fas fa-hand-holding-usd",user_tag:"fas fa-user-alt",toc_tag:"fas fa-th-list",read:"fas fa-book-reader",arrows:"fas fa-arrows-alt-h"}}</script><link data-swup-theme rel="stylesheet" href="/css/index.css?v=1.2.14" id="trm-switch-style"><script>let defaultMode="auto"!==ASYNC_CONFIG.theme.default?ASYNC_CONFIG.theme.default:window.matchMedia("(prefers-color-scheme: light)").matches?"style-light":"style-dark",catchMode=localStorage.getItem("theme-mode")||defaultMode,type="style-dark"===catchMode?"add":"remove";document.documentElement.classList[type]("dark")</script><script defer>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?bbad9d8e1fd8e044d365c2ce0d114c73";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="Cheny" type="application/atom+xml"></head><body><div class="trm-app-frame"><div class="trm-preloader"><div class="trm-holder"><div class="preloader"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div></div><div class="trm-mode-swich-animation-frame"><div class="trm-mode-swich-animation"><i class="i-sun"><i class="iconfont far fa-sun"></i></i><div class="trm-horizon"></div><i class="i-moon"><i class="iconfont far fa-moon"></i></i></div></div><div id="trm-dynamic-content" class="trm-swup-animation"><div id="trm-scroll-container" class="trm-scroll-container" data-scroll-container style="opacity:0"><div data-scroll-section id="content" class="trm-scroll-section"><div class="locomotive-scroll__sticky-target" style="position:absolute;top:0;left:0;right:0;bottom:0;pointer-events:none"></div><header class="trm-top-bar" data-scroll data-scroll-sticky data-scroll-target=".locomotive-scroll__sticky-target" data-scroll-offset="-10"><div class="container"><div class="trm-left-side"><a href="/" class="trm-logo-frame trm-anima-link"><img alt="logo" src="https://cheny-chenyu.oss-cn-chengdu.aliyuncs.com/img/blog-logo.png"></a></div><div class="trm-right-side"><div class="trm-menu"><nav><ul><li class="menu-item-has-children"><a href="/" target="">Home</a></li><li class="menu-item-has-children"><a href="/archives/" target="">Archives</a></li><li class="menu-item-has-children"><a href="/links/" target="">Links</a></li><li class="menu-item-has-children"><a href="/about/" target="">About</a><ul><li><a href="/projects/" target="">Projects</a></li><li><a data-no-swup href="https://foreverblog.cn/go.html" target="_blank">Forever Go</a></li></ul></li></ul></nav></div><div class="trm-mode-switcher-place"><div class="trm-mode-switcher"><i class="iconfont far fa-sun"></i> <input class="tgl tgl-light" id="trm-swich" type="checkbox"> <label class="trm-swich" for="trm-swich"></label> <i class="iconfont far fa-moon"></i></div></div><div id="trm-search-btn" class="trm-search-btn"><i class="iconfont fas fa-search"></i></div></div><div class="trm-menu-btn"><span></span></div></div></header><div class="trm-content-start"><div class="trm-banner" data-scroll data-scroll-direction="vertical"><img style="object-position:top;object-fit:cover" alt="banner" class="trm-banner-cover" data-scroll data-scroll-direction="vertical" data-scroll-speed="-3" src="/img/banner.png"><div class="trm-banner-content trm-overlay"><div class="container" data-scroll data-scroll-direction="vertical" data-scroll-speed="0"><div class="row"><div class="col-lg-4"></div><div class="col-lg-8"><div class="trm-banner-text"><div class="trm-label trm-mb-20">NEWS LETTER</div><h1 class="trm-mb-30 trm-hsmb-font">Node.js 【Koa】</h1><ul class="trm-breadcrumbs trm-label"><li><a href="/" class="trm-anima-link">Home</a></li><li><span>koa</span></li></ul></div><a href="#about-triger" data-scroll-to="#about-triger" data-scroll-offset="-130" class="trm-scroll-hint-frame"><div class="trm-scroll-hint"></div><span class="trm-label">Scroll down</span></a></div></div></div></div></div><div class="container"><div class="row"><div id="page-sidebar" class="col-lg-4 hidden-sm"><div class="trm-main-card-frame trm-sidebar"><div class="trm-main-card" data-scroll data-scroll-repeat data-scroll-sticky data-scroll-target=".locomotive-scroll__sticky-target" data-scroll-offset="60"><div class="trm-user-tabs" id="sidebar-tabs"><div class="trm-tabs-nav trm-mb-40" id="trm-tabs-nav"><div data-to="tabs-user" class="trm-tabs-nav-item"><i class="iconfont fas fa-user-alt"></i></div><div data-to="tabs-toc" class="trm-tabs-nav-item active"><i class="iconfont fas fa-th-list"></i></div></div><div name="tabs-user" class="trm-tabs-item"><div class="trm-mc-header"><div class="trm-avatar-frame trm-mb-20"><img alt="Avatar" class="trm-avatar" src="https://cheny-chenyu.oss-cn-chengdu.aliyuncs.com/img/ip.jpg"></div><h5 class="trm-name trm-mb-15">Cheny</h5><div class="trm-label">I`m <span class="trm-typed-text"></span></div></div><div class="trm-divider trm-mb-40 trm-mt-40"></div><div class="trm-social"><a href="https://github.com/ChenyCHENYU" title="Github" rel="nofollow" target="_blank"><i class="iconfont fab fa-github"></i> </a><a href="https://gitee.com/ycyplus163" title="Gitee" rel="nofollow" target="_blank"><i class="iconfont fab fa-github-alt"></i> </a><a href="https://www.tzagileteam.com/" title="AgileTeam" rel="nofollow" target="_blank"><i class="iconfont fas fa-blog"></i></a></div><div class="trm-divider trm-mb-40 trm-mt-40"></div><ul class="trm-table trm-mb-20"><li><div class="trm-label">Residence:</div><div class="trm-label trm-label-light">China</div></li><li><div class="trm-label">City:</div><div class="trm-label trm-label-light">Xi'An</div></li><li><div class="trm-label">Age:</div><div class="trm-label trm-label-light">33</div></li></ul><div class="trm-divider trm-mb-40 trm-mt-40"></div><div class="text-center"><a href="mailto:ycyplus@gmail.com" class="trm-btn">联系我 <i class="iconfont far fa-envelope"></i></a></div></div><div name="tabs-toc" class="trm-tabs-item active"><div class="post-toc"><ol class="toc"><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#KOA-一些-API-的使用" data-scroll-to="#KOA-一些-API-的使用"><span class="toc-number">1.</span> <span class="toc-text">KOA 一些 API 的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#设置响应头" data-scroll-to="#设置响应头"><span class="toc-number">1.1.</span> <span class="toc-text">设置响应头</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#批量注册路由-routes" data-scroll-to="#批量注册路由-routes"><span class="toc-number">1.2.</span> <span class="toc-text">批量注册路由 routes</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#控制器的处理封装-controllers" data-scroll-to="#控制器的处理封装-controllers"><span class="toc-number">1.3.</span> <span class="toc-text">控制器的处理封装 controllers</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#错误处理中间件-koa-json-error" data-scroll-to="#错误处理中间件-koa-json-error"><span class="toc-number">1.4.</span> <span class="toc-text">错误处理中间件 koa-json-error</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#windows-系统跨平台设置环境变量" data-scroll-to="#windows-系统跨平台设置环境变量"><span class="toc-number">1.5.</span> <span class="toc-text">windows 系统跨平台设置环境变量</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#koa-jwt-中间件" data-scroll-to="#koa-jwt-中间件"><span class="toc-number">1.6.</span> <span class="toc-text">koa-jwt 中间件</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#上传文件-使用-koa-body" data-scroll-to="#上传文件-使用-koa-body"><span class="toc-number">1.7.</span> <span class="toc-text">上传文件 使用 koa-body</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#使用-koa-static-中间件生成图片链接" data-scroll-to="#使用-koa-static-中间件生成图片链接"><span class="toc-number">1.8.</span> <span class="toc-text">使用 koa-static 中间件生成图片链接</span></a></li></ol></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#Koa-的使用" data-scroll-to="#Koa-的使用"><span class="toc-number">2.</span> <span class="toc-text">Koa 的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#初用-koa" data-scroll-to="#初用-koa"><span class="toc-number">2.1.</span> <span class="toc-text">初用 koa</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#koa-router" data-scroll-to="#koa-router"><span class="toc-number">2.2.</span> <span class="toc-text">koa-router</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#koa-中间件" data-scroll-to="#koa-中间件"><span class="toc-number">2.3.</span> <span class="toc-text">koa 中间件</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#koa-中的-ejs-模板引擎" data-scroll-to="#koa-中的-ejs-模板引擎"><span class="toc-number">2.4.</span> <span class="toc-text">koa 中的 ejs 模板引擎</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#koa-中-处理-post-的-koa-bodyparser-中间件" data-scroll-to="#koa-中-处理-post-的-koa-bodyparser-中间件"><span class="toc-number">2.5.</span> <span class="toc-text">koa 中 处理 post 的 koa-bodyparser 中间件</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#koa-static-静态资源中间件" data-scroll-to="#koa-static-静态资源中间件"><span class="toc-number">2.6.</span> <span class="toc-text">koa-static 静态资源中间件</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#art-template-模板引擎" data-scroll-to="#art-template-模板引擎"><span class="toc-number">2.7.</span> <span class="toc-text">art-template 模板引擎</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#koa-中-cookie-的使用" data-scroll-to="#koa-中-cookie-的使用"><span class="toc-number">2.8.</span> <span class="toc-text">koa 中 cookie 的使用</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#koa-中的-session" data-scroll-to="#koa-中的-session"><span class="toc-number">2.9.</span> <span class="toc-text">koa 中的 session</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#MongoDB-的封装及使用" data-scroll-to="#MongoDB-的封装及使用"><span class="toc-number">2.10.</span> <span class="toc-text">MongoDB 的封装及使用</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#验证码模块-svgCaptcha" data-scroll-to="#验证码模块-svgCaptcha"><span class="toc-number">2.11.</span> <span class="toc-text">验证码模块 svgCaptcha</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#利用-koa-jsonp-写-api-接口" data-scroll-to="#利用-koa-jsonp-写-api-接口"><span class="toc-number">2.12.</span> <span class="toc-text">利用 koa-jsonp 写 api 接口</span></a></li></ol></li></ol></div></div></div></div></div></div><div id="page-content" class="col-lg-8"><div class="trm-content" id="trm-content"><div data-scroll data-scroll-repeat data-scroll-offset="500" id="about-triger"></div><div id="post-info" class="row hidden-sm"><div class="col-sm-4"><div class="trm-card trm-label trm-label-light text-center"><i class="iconfont far fa-calendar-alt trm-icon"></i><br>11/21</div></div><div class="col-sm-4"><div class="trm-card trm-label trm-label-light text-center"><i class="iconfont far fa-clock trm-icon"></i><br>16:26</div></div><div class="col-sm-4"><div id="post-author" class="trm-card trm-label trm-label-light text-center"><i class="iconfont far fa-user trm-icon"></i><br>Cheny</div></div></div><div class="trm-card"><article id="article-container" class="trm-publication"><p>Koa 是 Node.js 的框架之一，使用洋葱模型，是一个轻量级的服务端应用。</p><h2 id="KOA-一些-API-的使用"><a href="#KOA-一些-API-的使用" class="headerlink" title="KOA 一些 API 的使用"></a>KOA 一些 API 的使用</h2><h3 id="设置响应头"><a href="#设置响应头" class="headerlink" title="设置响应头"></a>设置响应头</h3><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">ctx.<span class="title function_">set</span>(<span class="string">&#x27;Allow&#x27;</span>, <span class="string">&#x27;GET,POST&#x27;</span>)</span><br></pre></td></tr></table></figure><h3 id="批量注册路由-routes"><a href="#批量注册路由-routes" class="headerlink" title="批量注册路由 routes"></a>批量注册路由 routes</h3><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 新建一个 app 目录，下建 routes 目录 下建index.js</span></span><br><span class="line"><span class="comment">// 路由批量处理脚本</span></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"><span class="comment">// 批量化读取目录</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">app</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 同步读取目录</span></span><br><span class="line">  fs.<span class="title function_">readdirSync</span>(__dirname).<span class="title function_">forEach</span>(<span class="function"><span class="params">file</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 过滤掉目录下的index.js</span></span><br><span class="line">    <span class="keyword">if</span> (file === <span class="string">&#x27;index.js&#x27;</span>) &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">    <span class="comment">// 绕过 index.js 就开始注册路由</span></span><br><span class="line">    <span class="keyword">const</span> route = <span class="built_in">require</span>(<span class="string">`./<span class="subst">$&#123;file&#125;</span>`</span>)</span><br><span class="line">    app.<span class="title function_">use</span>(route.<span class="title function_">routes</span>()).<span class="title function_">use</span>(route.<span class="title function_">allowedMethods</span>())</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line">----------- 分割线  ------------</span><br><span class="line"><span class="comment">// 在app目录下的 index.js中</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Koa</span> = <span class="built_in">require</span>(<span class="string">&#x27;koa&#x27;</span>) <span class="comment">// 引入 Koa 依赖</span></span><br><span class="line"><span class="keyword">const</span> body = <span class="built_in">require</span>(<span class="string">&#x27;koa-body&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Koa</span>()  <span class="comment">// 实例化 Koa</span></span><br><span class="line"><span class="keyword">const</span> routing = <span class="built_in">require</span>(<span class="string">&#x27;./routes&#x27;</span>) <span class="comment">// 导入路由批量注册</span></span><br><span class="line"><span class="title function_">routing</span>(app) <span class="comment">// 调用这个函数</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">body</span>(&#123;</span><br><span class="line">  <span class="attr">multipart</span>: <span class="literal">true</span>,  <span class="comment">// 启用文件</span></span><br><span class="line">  <span class="attr">formidable</span>: &#123;</span><br><span class="line">    <span class="attr">uploadDir</span>: path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;/public/uploads&#x27;</span>), <span class="comment">// 上传目录</span></span><br><span class="line">    <span class="attr">keepExtensions</span>: <span class="literal">true</span>  <span class="comment">// 保证拓展名</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)) <span class="comment">// 使用body中间件</span></span><br><span class="line"><span class="comment">// 开启端口服务</span></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>, <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;程序启动成功在3000端口&#x27;</span>))</span><br></pre></td></tr></table></figure><h3 id="控制器的处理封装-controllers"><a href="#控制器的处理封装-controllers" class="headerlink" title="控制器的处理封装 controllers"></a>控制器的处理封装 controllers</h3><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 在 app目录下新建 controllers 目录</span></span><br><span class="line"><span class="comment">// 目录中的文件名对应的是路由中的文件名</span></span><br><span class="line"><span class="comment">// 控制器的本质是中间件 中间件的本质就是函数, 用类+类方法的方式</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HaomeCtl</span> &#123;</span><br><span class="line">  <span class="title function_">index</span>(<span class="params">ctx</span>) &#123;</span><br><span class="line">    ctx.<span class="property">body</span> = <span class="string">&#x27;这是首页&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">HaomeCtl</span>()</span><br><span class="line"><span class="comment">// 然后在 route 目录中的 home.js 中如下使用</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&#x27;koa-router&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> <span class="title class_">Router</span>()</span><br><span class="line"><span class="comment">// 使用控制器</span></span><br><span class="line"><span class="keyword">const</span> &#123; index &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../controllers/home&#x27;</span>)</span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, index)</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = router</span><br></pre></td></tr></table></figure><h3 id="错误处理中间件-koa-json-error"><a href="#错误处理中间件-koa-json-error" class="headerlink" title="错误处理中间件 koa-json-error"></a>错误处理中间件 koa-json-error</h3><p><code>npm install koa-json-error --save</code></p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 引用</span></span><br><span class="line"><span class="keyword">const</span> error = <span class="built_in">require</span>(<span class="string">&#x27;koa-json-error&#x27;</span>)</span><br><span class="line">app.<span class="title function_">use</span>(</span><br><span class="line">  <span class="title function_">error</span>(&#123;</span><br><span class="line">    <span class="comment">// 定制返回格式  process.env.NODE_ENV 获取环境变量</span></span><br><span class="line">    <span class="attr">postFormat</span>: <span class="function">(<span class="params">e, &#123; stack, ...rest &#125;</span>) =&gt;</span></span><br><span class="line">      process.<span class="property">env</span>.<span class="property">NODE_ENV</span> === <span class="string">&#x27;production&#x27;</span> ? rest : &#123; stack, ...rest &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">)</span><br></pre></td></tr></table></figure><h3 id="windows-系统跨平台设置环境变量"><a href="#windows-系统跨平台设置环境变量" class="headerlink" title="windows 系统跨平台设置环境变量"></a>windows 系统跨平台设置环境变量</h3><p><code>npm install cross-env --save-dev</code> 开发环境使用</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// package.json 就可以这么设置</span></span><br><span class="line">  <span class="string">&quot;scripts&quot;</span>: &#123;</span><br><span class="line">      <span class="comment">// 注意 NODE_ENV=production  =号左右不能有间隙</span></span><br><span class="line">    <span class="string">&quot;start&quot;</span>: <span class="string">&quot;cross-env NODE_ENV=production node app&quot;</span>, <span class="comment">// 生产</span></span><br><span class="line">    <span class="string">&quot;dev&quot;</span>: <span class="string">&quot;nodemon app&quot;</span> <span class="comment">// 开发环境</span></span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure><h3 id="koa-jwt-中间件"><a href="#koa-jwt-中间件" class="headerlink" title="koa-jwt 中间件"></a>koa-jwt 中间件</h3><p><code>npm i koa-jwt --save</code></p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">&#x27;koa-jwt&#x27;</span>)</span><br><span class="line"><span class="comment">// 使用 koa-jwt 认证 secret 是自己设置的密码</span></span><br><span class="line"><span class="keyword">const</span> auth = <span class="title function_">jwt</span>(&#123; secret &#125;)</span><br></pre></td></tr></table></figure><h3 id="上传文件-使用-koa-body"><a href="#上传文件-使用-koa-body" class="headerlink" title="上传文件 使用 koa-body"></a>上传文件 使用 koa-body</h3><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">app.<span class="title function_">use</span>(</span><br><span class="line">  <span class="title function_">body</span>(&#123;</span><br><span class="line">    <span class="attr">multipart</span>: <span class="literal">true</span>, <span class="comment">// 启用文件</span></span><br><span class="line">    <span class="attr">formidable</span>: &#123;</span><br><span class="line">      <span class="attr">uploadDir</span>: path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;/public/uploads&#x27;</span>), <span class="comment">// 上传目录</span></span><br><span class="line">      <span class="attr">keepExtensions</span>: <span class="literal">true</span>, <span class="comment">// 保证拓展名</span></span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">)</span><br><span class="line"><span class="comment">// 使用body中间件</span></span><br><span class="line"><span class="comment">// 控制器中</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HaomeCtl</span> &#123;</span><br><span class="line">  <span class="title function_">index</span>(<span class="params">ctx</span>) &#123;</span><br><span class="line">    ctx.<span class="property">body</span> = <span class="string">&#x27;这是首页&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">upload</span>(<span class="params">ctx</span>) &#123;</span><br><span class="line">    <span class="comment">// 注意这里</span></span><br><span class="line">    <span class="keyword">const</span> file = ctx.<span class="property">request</span>.<span class="property">files</span>.<span class="property">file</span></span><br><span class="line">    ctx.<span class="property">body</span> = &#123; <span class="attr">path</span>: file.<span class="property">path</span> &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">HaomeCtl</span>()</span><br><span class="line"><span class="comment">// 在路由中使用</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&#x27;koa-router&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> <span class="title class_">Router</span>()</span><br><span class="line"><span class="comment">// 使用控制器</span></span><br><span class="line"><span class="keyword">const</span> &#123; index, upload &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../controllers/home&#x27;</span>)</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, index).<span class="title function_">get</span>(<span class="string">&#x27;/upload&#x27;</span>, upload)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = router</span><br></pre></td></tr></table></figure><h3 id="使用-koa-static-中间件生成图片链接"><a href="#使用-koa-static-中间件生成图片链接" class="headerlink" title="使用 koa-static 中间件生成图片链接"></a>使用 koa-static 中间件生成图片链接</h3><p><code>npm i koa-static --save</code></p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> koaStatic = <span class="built_in">require</span>(<span class="string">&#x27;koa-static&#x27;</span>)</span><br><span class="line">app.<span class="title function_">use</span>(</span><br><span class="line">  <span class="title function_">koaStatic</span>(</span><br><span class="line">    <span class="comment">// 放最前面，静态文件 use 都写在前面</span></span><br><span class="line">    path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;public&#x27;</span>)</span><br><span class="line">  )</span><br><span class="line">)</span><br><span class="line"><span class="comment">// ----&gt;</span></span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HaomeCtl</span> &#123;</span><br><span class="line">  <span class="title function_">index</span>(<span class="params">ctx</span>) &#123;</span><br><span class="line">    ctx.<span class="property">body</span> = <span class="string">&#x27;这是首页&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">upload</span>(<span class="params">ctx</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> file = ctx.<span class="property">request</span>.<span class="property">files</span>.<span class="property">file</span></span><br><span class="line">    <span class="keyword">const</span> basename = path.<span class="title function_">basename</span>(file.<span class="property">path</span>)</span><br><span class="line">    ctx.<span class="property">body</span> = &#123; <span class="attr">url</span>: <span class="string">`<span class="subst">$&#123;ctx.origin&#125;</span>/uploads<span class="subst">$&#123;basename&#125;</span>`</span> &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">HaomeCtl</span>()</span><br></pre></td></tr></table></figure><h2 id="Koa-的使用"><a href="#Koa-的使用" class="headerlink" title="Koa 的使用"></a>Koa 的使用</h2><h3 id="初用-koa"><a href="#初用-koa" class="headerlink" title="初用 koa"></a>初用 koa</h3><p><code>npm install koa --save</code></p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 引入 koa 模块</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Koa</span> = <span class="built_in">require</span>(<span class="string">&#x27;koa&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建 koa 实例</span></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Koa</span>()</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="keyword">async</span> (ctx) =&gt; &#123;</span><br><span class="line">  ctx.<span class="property">body</span> = <span class="string">&#x27;哈哈 你好 koa2 我来学习你了&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 启动服务</span></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3001</span>)</span><br></pre></td></tr></table></figure><h3 id="koa-router"><a href="#koa-router" class="headerlink" title="koa-router"></a>koa-router</h3><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">.<span class="title function_">prefix</span>(prefix) =&gt; <span class="title class_">Router</span> <span class="comment">// 加前缀</span></span><br><span class="line"><span class="keyword">const</span> usersRouter = <span class="keyword">new</span> <span class="title class_">Router</span>().<span class="title function_">prefix</span>(<span class="string">&#x27;/users&#x27;</span>) <span class="comment">// 配置前缀</span></span><br></pre></td></tr></table></figure><p><code>npm install koa-router --save</code></p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 引入</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&#x27;koa-router&#x27;</span>)</span><br><span class="line"><span class="comment">// 也可以引入并实例化</span></span><br><span class="line"><span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">&#x27;koa-router&#x27;</span>)()</span><br><span class="line">===&gt; 上面更精简</span><br><span class="line">或者 <span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&#x27;koa-router&#x27;</span>)</span><br><span class="line">     <span class="keyword">const</span> router = <span class="keyword">new</span> <span class="title class_">Router</span>()</span><br><span class="line"><span class="comment">// 启动路由</span></span><br><span class="line">app.<span class="title function_">use</span>(router.<span class="title function_">routes</span>()) <span class="comment">// 记得引入koa 并创建实例后使用这个中间件</span></span><br><span class="line">app.<span class="title function_">use</span>(router.<span class="property">allowedMethods</span>) <span class="comment">// 响应options方法，告知所支付的方法</span></span><br><span class="line"><span class="comment">// 而且会返回405 及 501状态码 请求的方法还没写及不支持该方法</span></span><br><span class="line"><span class="comment">// 使用</span></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>,<span class="function">(<span class="params">ctx,next</span>)=&gt;</span>&#123;  <span class="comment">// next 是下一个中间件</span></span><br><span class="line">    cty.<span class="property">body</span> = <span class="string">&#x27;hello koa&#x27;</span></span><br><span class="line">&#125;) <span class="comment">// ...</span></span><br></pre></td></tr></table></figure><p>栗：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 引入 koa 模块</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Koa</span> = <span class="built_in">require</span>(<span class="string">&#x27;koa&#x27;</span>)</span><br><span class="line"><span class="comment">// 引入 koa 路由模块</span></span><br><span class="line"><span class="keyword">var</span> router = <span class="built_in">require</span>(<span class="string">&#x27;koa-router&#x27;</span>)()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建 koa 实例</span></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Koa</span>()</span><br><span class="line"><span class="comment">// 创建一个 router 实例</span></span><br><span class="line"><span class="comment">// const router = new Router()</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用路由</span></span><br><span class="line">app.<span class="title function_">use</span>(router.<span class="title function_">routes</span>()).<span class="title function_">use</span>(router.<span class="property">allowedMethods</span>) <span class="comment">// 帮你自动添加响应头</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置路由</span></span><br><span class="line">router</span><br><span class="line">  .<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="keyword">async</span> (ctx) =&gt; &#123;</span><br><span class="line">    ctx.<span class="property">body</span> = <span class="string">&#x27;首页&#x27;</span> <span class="comment">// 返回数据 原生里面res.end/write</span></span><br><span class="line">  &#125;)</span><br><span class="line">  .<span class="title function_">get</span>(<span class="string">&#x27;/news&#x27;</span>, <span class="keyword">async</span> (ctx) =&gt; &#123;</span><br><span class="line">    ctx.<span class="property">body</span> = <span class="string">&#x27;新闻页面&#x27;</span></span><br><span class="line">  &#125;)</span><br><span class="line">  .<span class="title function_">get</span>(<span class="string">&#x27;/newscontent&#x27;</span>, <span class="keyword">async</span> (ctx) =&gt; &#123;</span><br><span class="line">    ctx.<span class="property">body</span> = <span class="string">&#x27;新闻详情&#x27;</span></span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 启动服务</span></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3001</span>)</span><br></pre></td></tr></table></figure><h3 id="koa-中间件"><a href="#koa-中间件" class="headerlink" title="koa 中间件"></a>koa 中间件</h3><ul><li>应用级中间件，比如 <code>app.use()</code></li></ul><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">app.<span class="title function_">use</span>(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 中间件 通过 next () 实现</span></span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">next</span>()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><ul><li>路由级中间件：</li></ul><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">  .<span class="title function_">get</span>(<span class="string">&#x27;/newscontent&#x27;</span>, <span class="keyword">async</span> (ctx,next) =&gt; &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;新闻详情&#x27;</span>)</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">next</span>()</span><br><span class="line">  &#125;)</span><br><span class="line">  .<span class="title function_">get</span>(<span class="string">&#x27;/newscontent&#x27;</span>,<span class="title function_">async</span>(ctx, next)=&gt;&#123;</span><br><span class="line">     ctx.<span class="property">body</span> = <span class="string">&#x27;新闻详情&#x27;</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><ul><li>错误处理中间件</li></ul><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 注意要写在上面 执行顺序 上下文</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;这是一个中间件&#x27;</span>)</span><br><span class="line">  <span class="title function_">next</span>()</span><br><span class="line">  <span class="keyword">if</span> (ctx.<span class="property">status</span> == <span class="number">404</span>) &#123;</span><br><span class="line">    ctx.<span class="property">status</span> = <span class="number">404</span></span><br><span class="line">    ctx.<span class="property">body</span> = <span class="string">&#x27;这是一个404页面&#x27;</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(ctx.<span class="property">url</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><ul><li>第三方中间件</li></ul><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">比如静态服务中间件</span><br><span class="line">post 中间件等等</span><br></pre></td></tr></table></figure><ul><li>中间件配置公共信息</li></ul><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">ctx.<span class="property">state</span> = &#123;</span><br><span class="line">    <span class="comment">// 配置公共信息</span></span><br><span class="line">&#125;</span><br><span class="line">----- 实例 -----</span><br><span class="line"> <span class="comment">// 写一个中间件来配置公共的信息</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="keyword">async</span> (ctx) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 这样配置了 任何一个路由都可以使用这个数据</span></span><br><span class="line">  ctx.<span class="property">state</span>.<span class="property">useinfo</span> = <span class="string">&#x27;张三&#x27;</span></span><br><span class="line">  <span class="title function_">next</span>()  <span class="comment">// 继续向下匹配路由</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="koa-中的-ejs-模板引擎"><a href="#koa-中的-ejs-模板引擎" class="headerlink" title="koa 中的 ejs 模板引擎"></a>koa 中的 ejs 模板引擎</h3><p><code>npm install koa-views --save &amp;&amp; npm install ejs --save</code></p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 引入</span></span><br><span class="line"><span class="keyword">const</span> views = <span class="built_in">require</span>(<span class="string">&#x27;koa-views&#x27;</span>)</span><br><span class="line"><span class="comment">// 使用</span></span><br><span class="line"><span class="comment">// 这样配置后缀是 html</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">views</span>(<span class="string">&#x27;views&#x27;</span>, &#123; <span class="attr">map</span>: &#123; <span class="attr">html</span>: <span class="string">&#x27;ejs&#x27;</span> &#125; &#125;))</span><br><span class="line"><span class="comment">// 这样配置后缀是 ejs</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">views</span>(<span class="string">&#x27;views&#x27;</span>, &#123; <span class="attr">extension</span>: <span class="string">&#x27;ejs&#x27;</span> &#125;))</span><br><span class="line"><span class="comment">// 通过 await ctx.render() 渲染 ejs 模板引擎</span></span><br><span class="line"><span class="keyword">await</span> ctx.<span class="title function_">render</span>(<span class="string">&#x27;index&#x27;</span>)</span><br></pre></td></tr></table></figure><p>栗：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">router</span><br><span class="line">  .<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="keyword">async</span> (ctx) =&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> title = <span class="string">&#x27;我是要传入 ejs 文件中的数据&#x27;</span></span><br><span class="line">    <span class="keyword">let</span> arr = [<span class="number">111</span>, <span class="number">222</span>, <span class="number">333</span>]</span><br><span class="line">    <span class="keyword">await</span> ctx.<span class="title function_">render</span>(<span class="string">&#x27;index&#x27;</span>, &#123;   <span class="comment">// 绑定数据 真实数据要从数据库拿</span></span><br><span class="line">      title,</span><br><span class="line">      arr</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line"><span class="comment">// ejs 文件中</span></span><br><span class="line">&lt;body&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>这是一个 ejs 的模板引擎<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">h3</span>&gt;</span>&lt;%=title%&gt;<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span></span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    &lt;%for (var i = 0; i&lt;arr.length; i++)&#123;%&gt;  // 循环 ejs 数据</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">li</span>&gt;</span>&lt;%=arr[i]%&gt;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    &lt;%&#125;%&gt;</span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 引入某个 ejs 模块的内容</span></span><br><span class="line">&lt;% include public/header.<span class="property">ejs</span>%&gt; <span class="comment">// 在index.ejs 引入 public/header.ejs</span></span><br><span class="line"><span class="comment">// 解析 html 标签</span></span><br><span class="line"> &lt;%-content%&gt;</span><br></pre></td></tr></table></figure><h3 id="koa-中-处理-post-的-koa-bodyparser-中间件"><a href="#koa-中-处理-post-的-koa-bodyparser-中间件" class="headerlink" title="koa 中 处理 post 的 koa-bodyparser 中间件"></a>koa 中 处理 post 的 koa-bodyparser 中间件</h3><p><code>npm install koa-bodyparser --save</code></p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 引入配置中间件</span></span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">&#x27;koa-bodyparser&#x27;</span>)</span><br><span class="line"><span class="comment">// 使用中间件</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">bodyParser</span>())</span><br><span class="line"><span class="comment">// 获取表单提交的 post 数据</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/doAdd&#x27;</span>, <span class="keyword">async</span> (ctx) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 获取表单提交的数据</span></span><br><span class="line">  ctx.<span class="property">body</span> = ctx.<span class="property">request</span>.<span class="property">body</span> <span class="comment">// 获取</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="koa-static-静态资源中间件"><a href="#koa-static-静态资源中间件" class="headerlink" title="koa-static 静态资源中间件"></a>koa-static 静态资源中间件</h3><p><strong>npm install koa-static –save</strong></p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 使用</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">static</span> = <span class="built_in">require</span>(<span class="string">&#x27;koa-static&#x27;</span>)</span><br><span class="line"><span class="comment">// 使用 配置静态 web 服务的中间件</span></span><br><span class="line"><span class="comment">// 去static目录找 找到返回 找不到继续next</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">static</span>(__dirname+<span class="string">&#x27;/public&#x27;</span>))</span><br><span class="line"><span class="comment">// 静态资源中间件可以配置多个</span></span><br><span class="line">------------ 分割线 ------------</span><br><span class="line"><span class="comment">// 配置中间件 获取url的地址</span></span><br><span class="line">router.<span class="title function_">use</span>(<span class="keyword">async</span> (ctx) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 模板引擎配置全局变量</span></span><br><span class="line">  ctx.<span class="property">state</span>.<span class="property">__HOST__</span> = <span class="string">&#x27;http://&#x27;</span> + ctx.<span class="property">request</span>.<span class="property">header</span>.<span class="property">host</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 使用配置的HOST变量</span></span><br><span class="line">&lt;link rel=<span class="string">&quot;stylesheet&quot;</span> href=<span class="string">&quot;&#123;&#123;__HOST__&#125;&#125;/admin/css/font-aw.min.css&quot;</span> /&gt;</span><br></pre></td></tr></table></figure><h3 id="art-template-模板引擎"><a href="#art-template-模板引擎" class="headerlink" title="art-template 模板引擎"></a>art-template 模板引擎</h3><p><code>npm install art-template --save &amp;&amp; npm install koa-art-template --save</code></p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 引入</span></span><br><span class="line"><span class="keyword">const</span> render = <span class="built_in">require</span>(<span class="string">&#x27;koa-art-template&#x27;</span>)</span><br><span class="line"><span class="comment">// 配置 koa-art-template 模板引擎</span></span><br><span class="line"><span class="title function_">render</span>(app, &#123;</span><br><span class="line">  <span class="attr">root</span>: path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;views&#x27;</span>), <span class="comment">// 视图的位置</span></span><br><span class="line">  <span class="attr">extname</span>: <span class="string">&#x27;.html&#x27;</span>, <span class="comment">// 后缀名</span></span><br><span class="line">  <span class="attr">debug</span>: process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>, <span class="comment">// 是否开启调试</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 使用</span></span><br><span class="line"><span class="keyword">await</span> ctx.<span class="title function_">render</span>(<span class="string">&#x27;user&#x27;</span>)</span><br></pre></td></tr></table></figure><p>栗：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&#123;&#123;include <span class="string">&#x27;public/footer.html&#x27;</span>&#125;&#125; <span class="comment">// 引入公共文件</span></span><br><span class="line">&#123;&#123;obj.<span class="property">name</span>&#125;&#125; <span class="comment">// 获取值</span></span><br><span class="line">&#123;&#123;@obj.<span class="property">h</span>&#125;&#125; <span class="comment">// 获取标签元素</span></span><br><span class="line">&#123;&#123;<span class="keyword">if</span> num &gt;<span class="number">20</span>&#125;&#125; 大于 <span class="number">20</span> &#123;&#123;<span class="keyword">else</span>&#125;&#125; 小于等于 <span class="number">20</span> &#123;&#123;<span class="regexp">/if&#125;&#125; /</span><span class="regexp">/ 条件判断</span></span><br><span class="line"><span class="regexp">&lt;ul&gt;</span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ each 循环</span></span><br><span class="line"><span class="regexp">  &#123;&#123;each obj.arr&#125;&#125;</span></span><br><span class="line"><span class="regexp">    &lt;li&gt;&#123;&#123;$index&#125;&#125; ----  &#123;&#123;$value&#125;&#125;&lt;/</span>li&gt;</span><br><span class="line">  &#123;&#123;/each&#125;&#125;</span><br><span class="line">&lt;/ul&gt;</span><br><span class="line"><span class="comment">// NODE JS 文件中</span></span><br><span class="line">router</span><br><span class="line">  .<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="keyword">async</span> (ctx) =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> obj = &#123;   <span class="comment">// 这些数据真实的应该从数据库拿 这里模拟</span></span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;张三&#x27;</span>,</span><br><span class="line">      <span class="attr">h</span>: <span class="string">&#x27;&lt;h1&gt;我是一个h1&lt;/h1&gt;&#x27;</span>,</span><br><span class="line">      <span class="attr">num</span>: <span class="number">20</span>,</span><br><span class="line">      <span class="attr">arr</span>: [<span class="number">111</span>,<span class="number">222</span>,<span class="number">333</span>]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">await</span> ctx.<span class="title function_">render</span>(<span class="string">&#x27;index&#x27;</span>, &#123;</span><br><span class="line">      obj</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure><h3 id="koa-中-cookie-的使用"><a href="#koa-中-cookie-的使用" class="headerlink" title="koa 中 cookie 的使用"></a>koa 中 cookie 的使用</h3><ul><li>保存用户信息</li><li>浏览器历史记录</li><li>猜你喜欢的功能</li><li>10 天免登陆</li><li>多个页面之间的数据传递</li></ul><p><strong>cookie 参数：</strong></p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">maxAage <span class="comment">// 设置过期时间</span></span><br><span class="line">expires <span class="comment">// cookie 过期的 Date  这里设置具体的时间</span></span><br><span class="line">path <span class="comment">// coolie 路径 默认是&#x27;/&#x27;  配置可以拿到cookie的路由</span></span><br><span class="line">domain <span class="comment">// cookie 域名</span></span><br><span class="line">secure <span class="comment">// 安全 cookie 默认 false 设置成 true 只能 https 访问</span></span><br><span class="line">httpOnly <span class="comment">// 是否只有服务器可以访问 cookie 默认是 true</span></span><br><span class="line">overwrite <span class="comment">// 默认 false 如果是 true 会覆盖过滤</span></span><br></pre></td></tr></table></figure><p><strong>koa 中设置 和获取 cookie 的值:</strong></p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 设置 cookie 的值</span></span><br><span class="line">ctx.<span class="property">cookies</span>.<span class="title function_">set</span>(name.<span class="property">value</span>,[options])</span><br><span class="line"><span class="comment">// 获取 cookie 的值</span></span><br><span class="line">ctx.<span class="property">cookies</span>.<span class="title function_">get</span>(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line"><span class="comment">// 中文问题</span></span><br><span class="line">设置的时候先把先将它转成 ‘ base64 ’ 编码来存储　　</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Buffer</span>(value).<span class="title function_">toString</span>(<span class="string">&#x27;base64&#x27;</span>)</span><br><span class="line"> </span><br><span class="line">使用的时候再转换回来</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Buffer</span>(value,<span class="string">&#x27;base64&#x27;</span>).<span class="title function_">toString</span>()</span><br></pre></td></tr></table></figure><h3 id="koa-中的-session"><a href="#koa-中的-session" class="headerlink" title="koa 中的 session"></a>koa 中的 session</h3><p><strong>session 的工作流程：</strong></p><p>当浏览器访问服务器并发送第一个请求时，服务器会创建一个 session 对象，生成一个类似于 key,value 的键值对，然后将 key(cookie)返回到浏览器(客户端)，浏览器下次再访问时，携带 key(cookie)，找到对应的 session(value),客户的信息保存在 session 中。</p><p><strong>koa-session 的使用：</strong></p><p><code>npm install koa-session --sava</code></p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 引入</span></span><br><span class="line"><span class="keyword">const</span> session = <span class="built_in">require</span>(<span class="string">&#x27;koa-session&#x27;</span>)</span><br><span class="line"><span class="comment">// 配置 session 中间件</span></span><br><span class="line">app.<span class="property">keys</span> = [<span class="string">&#x27;some secret hurr&#x27;</span>] <span class="comment">// 这个是配合signed属性的签名ke</span></span><br><span class="line"><span class="comment">// 配置信息</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">CONFIG</span> = &#123;</span><br><span class="line">  <span class="attr">key</span>: <span class="string">&#x27;koa:sess&#x27;</span>, <span class="comment">//cookie key (default is koa:sess)</span></span><br><span class="line">  <span class="attr">maxAge</span>: <span class="number">86400000</span>, <span class="comment">// cookie 的过期时间 maxAge in ms (default is 1 days)</span></span><br><span class="line">  <span class="attr">overwrite</span>: <span class="literal">true</span>, <span class="comment">//是否可以 overwrite (默认 default true)</span></span><br><span class="line">  <span class="attr">httpOnly</span>: <span class="literal">true</span>, <span class="comment">//cookie 是否只有服务器端可以访问 httpOnly or not (default true)</span></span><br><span class="line">  <span class="attr">signed</span>: <span class="literal">true</span>, <span class="comment">//签名默认 true</span></span><br><span class="line">  <span class="attr">rolling</span>: <span class="literal">false</span>, <span class="comment">//在每次请求时强行设置 cookie，这将重置 cookie 过期时间（默认：false）</span></span><br><span class="line">  <span class="attr">renew</span>: <span class="literal">false</span>, <span class="comment">//(boolean) renew session when session is nearly expired,</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 使用</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">session</span>(<span class="variable constant_">CONFIG</span>, app))</span><br><span class="line"><span class="comment">// 设置</span></span><br><span class="line">ctx.<span class="property">session</span>.<span class="property">username</span> = <span class="string">&#x27;张三&#x27;</span></span><br><span class="line"><span class="comment">// 获取</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(ctx.<span class="property">session</span>.<span class="property">userinfo</span>)</span><br></pre></td></tr></table></figure><p>栗：</p><p>🔔 注意：使用路由一定把启动路由放在下面 否则拿不到 <code>session</code> 的数据。</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 配置路由</span></span><br><span class="line">router</span><br><span class="line">  .<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="keyword">async</span> (ctx) =&gt; &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(ctx.<span class="property">session</span>.<span class="property">userinfo</span>) <span class="comment">// 获取 session</span></span><br><span class="line">    ctx.<span class="property">body</span> = <span class="string">&#x27;首页&#x27;</span> + ctx.<span class="property">session</span>.<span class="property">userinfo</span></span><br><span class="line">  &#125;)</span><br><span class="line">  .<span class="title function_">get</span>(<span class="string">&#x27;/news&#x27;</span>, <span class="keyword">async</span> (ctx) =&gt; &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(ctx.<span class="property">session</span>.<span class="property">userinfo</span>) <span class="comment">// 获取 session</span></span><br><span class="line">    ctx.<span class="property">body</span> = <span class="string">`登录成功`</span></span><br><span class="line">  &#125;)</span><br><span class="line">  .<span class="title function_">get</span>(<span class="string">&#x27;/login&#x27;</span>, <span class="keyword">async</span> (ctx) =&gt; &#123;</span><br><span class="line">    ctx.<span class="property">session</span>.<span class="property">userinfo</span> = <span class="string">&#x27;张三&#x27;</span> <span class="comment">// 设置 session</span></span><br><span class="line">    ctx.<span class="property">body</span> = <span class="string">`登录成功`</span></span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 接收 post 提交的数据</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/doAdd&#x27;</span>, <span class="keyword">async</span> (ctx) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 获取表单提交的数据</span></span><br><span class="line">  ctx.<span class="property">body</span> = ctx.<span class="property">request</span>.<span class="property">body</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用路由 要放在下面位置 不然巨坑 拿不到session的数据</span></span><br><span class="line">app.<span class="title function_">use</span>(router.<span class="title function_">routes</span>()).<span class="title function_">use</span>(router.<span class="property">allowedMethods</span>)</span><br></pre></td></tr></table></figure><h3 id="MongoDB-的封装及使用"><a href="#MongoDB-的封装及使用" class="headerlink" title="MongoDB 的封装及使用"></a>MongoDB 的封装及使用</h3><p>ES6 的简单封装单例模式。</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Db</span> &#123;</span><br><span class="line">  <span class="comment">// 静态方法实现单例</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">getInstance</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title class_">Db</span>.<span class="property">instance</span>) &#123;</span><br><span class="line">      <span class="title class_">Db</span>.<span class="property">instance</span> = <span class="keyword">new</span> <span class="title class_">Db</span>()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Db</span>.<span class="property">instance</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;实例化触发构造函数&#x27;</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">connect</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">connect</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;链接数据库&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">find</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;查询数据库&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> myDb = <span class="title class_">Db</span>.<span class="title function_">getInstance</span>()</span><br></pre></td></tr></table></figure><p>安装以及简单使用：</p><p><code>npm install mongodb --save-dev</code></p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 引入</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">MongoClient</span> = <span class="built_in">require</span>(<span class="string">&#x27;mongodb&#x27;</span>).<span class="property">MongoClient</span></span><br><span class="line"><span class="comment">// 定义地址</span></span><br><span class="line"><span class="keyword">const</span> dbUrl = <span class="string">&#x27;mongodb://localhost:27017/&#x27;</span></span><br><span class="line"><span class="keyword">const</span> dbName = <span class="string">&#x27;demo&#x27;</span> <span class="comment">// 要链接的数据库名字</span></span><br><span class="line"><span class="comment">// 链接数据库</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">time</span>(<span class="string">&#x27;start&#x27;</span>) <span class="comment">// 测试事件</span></span><br><span class="line"><span class="title class_">MongoClient</span>.<span class="title function_">connect</span>(dbUrl, &#123; <span class="attr">useNewUrlParser</span>: <span class="literal">true</span> &#125;, <span class="function">(<span class="params">err, client</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (err) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(err)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 链接上 db 数据库</span></span><br><span class="line">  <span class="keyword">let</span> db = client.<span class="title function_">db</span>(dbName)</span><br><span class="line">  <span class="comment">// 增加数据</span></span><br><span class="line">  db.<span class="title function_">collection</span>(<span class="string">&#x27;user&#x27;</span>).<span class="title function_">insertOne</span>(</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">username</span>: <span class="string">&#x27;王武&#x27;</span>,</span><br><span class="line">      <span class="attr">age</span>: <span class="number">32</span>,</span><br><span class="line">      <span class="attr">sex</span>: <span class="string">&#x27;男&#x27;</span>,</span><br><span class="line">      <span class="attr">status</span>: <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function">(<span class="params">err, result</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!err) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;增加数据成功&#x27;</span>)</span><br><span class="line">        <span class="comment">// 关闭数据库</span></span><br><span class="line">        client.<span class="title function_">close</span>()</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">timeEnd</span>(<span class="string">&#x27;start&#x27;</span>) <span class="comment">// 测试事件</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  )</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 查询数据</span></span><br><span class="line"><span class="comment">// 拿到所有该数据库下某个集合的所有数据</span></span><br><span class="line"><span class="keyword">let</span> result = db.<span class="title function_">collection</span>(<span class="string">&#x27;user&#x27;</span>).<span class="title function_">find</span>(&#123;&#125;)</span><br><span class="line">result.<span class="title function_">toArray</span>(<span class="function">(<span class="params">err, docs</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(docs)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>提高性能，单例封装:</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// config.js</span></span><br><span class="line"><span class="keyword">const</span> app = &#123;</span><br><span class="line">  <span class="comment">// 数据库的 url</span></span><br><span class="line">  <span class="attr">dbUrl</span>: <span class="string">&#x27;mongodb://localhost:27017&#x27;</span>,</span><br><span class="line">  <span class="comment">// 链接的数据库名称</span></span><br><span class="line">  <span class="attr">dbName</span>: <span class="string">&#x27;demo&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 暴露配置信息出去</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = app;</span><br><span class="line">------------ 分割 ---------</span><br><span class="line"><span class="comment">// 引入</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">MongoClient</span> = <span class="built_in">require</span>(<span class="string">&#x27;mongodb&#x27;</span>).<span class="property">MongoClient</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">ObjectID</span> = <span class="built_in">require</span>(<span class="string">&#x27;mongodb&#x27;</span>).<span class="property">ObjectID</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Config</span> = <span class="built_in">require</span>(<span class="string">&#x27;./config.js&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 封装类库</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Db</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 单例模式</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">getInstance</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title class_">Db</span>.<span class="property">instance</span>) &#123;</span><br><span class="line">      <span class="title class_">Db</span>.<span class="property">instance</span> = <span class="keyword">new</span> <span class="title class_">Db</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Db</span>.<span class="property">instance</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">   <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dbClient</span> = <span class="string">&#x27;&#x27;</span>;  <span class="comment">// 属性 放db对象 为了只链接一次</span></span><br><span class="line">    <span class="comment">// 初始化的时候链接数据库</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">connect</span>()</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// 链接数据库</span></span><br><span class="line">  <span class="title function_">connect</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">dbClient</span>) &#123;</span><br><span class="line">        <span class="title class_">MongoClient</span>.<span class="title function_">connect</span>(<span class="title class_">Config</span>.<span class="property">dbUrl</span>, &#123; <span class="attr">useNewUrlParser</span>: <span class="literal">true</span> &#125;, <span class="function">(<span class="params">err, client</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (err) &#123;</span><br><span class="line">            <span class="title function_">reject</span>(<span class="string">&#x27;链接数据库失败&#x27;</span>);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> db = client.<span class="title function_">db</span>(<span class="title class_">Config</span>.<span class="property">dbName</span>);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">dbClient</span> = db;</span><br><span class="line">            <span class="title function_">resolve</span>(db);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_">resolve</span>(<span class="variable language_">this</span>.<span class="property">dbClient</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// 查询数据</span></span><br><span class="line">  <span class="title function_">find</span>(<span class="params">collectionName, json</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">connect</span>().<span class="title function_">then</span>(<span class="function">(<span class="params">db</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> result = db.<span class="title function_">collection</span>(collectionName).<span class="title function_">find</span>(json);</span><br><span class="line">        result.<span class="title function_">toArray</span>(<span class="function">(<span class="params">err, docs</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (err) &#123;</span><br><span class="line">            <span class="title function_">reject</span>(<span class="string">&#x27;数据找不到对应的集合（表）,请检查&#x27;</span>)</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="title function_">resolve</span>(docs)</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 更新数据</span></span><br><span class="line">  <span class="title function_">update</span>(<span class="params">collectionName, json1, json2</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">connect</span>().<span class="title function_">then</span>(<span class="function">(<span class="params">db</span>) =&gt;</span> &#123;</span><br><span class="line">        db.<span class="title function_">collection</span>(collectionName).<span class="title function_">updateOne</span>(json1, &#123;</span><br><span class="line">          <span class="attr">$set</span>: json2</span><br><span class="line">        &#125;, <span class="function">(<span class="params">err, result</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (err) &#123;</span><br><span class="line">            <span class="title function_">reject</span>(<span class="string">&#x27;更新数据失败&#x27;</span>);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="title function_">resolve</span>(result)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 增加数据</span></span><br><span class="line">  <span class="title function_">insert</span>(<span class="params">collectionName, json</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">connect</span>().<span class="title function_">then</span>(<span class="function">(<span class="params">db</span>) =&gt;</span> &#123;</span><br><span class="line">        db.<span class="title function_">collection</span>(collectionName).<span class="title function_">insertOne</span>(json, <span class="function">(<span class="params">err, result</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (err) &#123;</span><br><span class="line">            <span class="title function_">reject</span>(<span class="string">&#x27;添加数据失败&#x27;</span>)</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="title function_">resolve</span>(result)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// 删除数据</span></span><br><span class="line">  <span class="title function_">remove</span>(<span class="params">collectionName, json</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">connect</span>().<span class="title function_">then</span>(<span class="function">(<span class="params">db</span>) =&gt;</span> &#123;</span><br><span class="line">        db.<span class="title function_">collection</span>(collectionName).<span class="title function_">removeOne</span>(json, <span class="function">(<span class="params">err, result</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (err) &#123;</span><br><span class="line">            <span class="title function_">reject</span>(<span class="string">&#x27;删除数据失败&#x27;</span>)</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="title function_">resolve</span>(result)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">    <span class="comment">// 封装获取id</span></span><br><span class="line">  <span class="comment">// mongodb 里面查询_id 吧字符串转换成对象</span></span><br><span class="line">  <span class="title function_">getObjectId</span>(<span class="params">id</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ObjectID</span>(id)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// let myDb = Db.getInstance()</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// myDb.find(&#x27;user&#x27;, &#123;&#125;).then((data) =&gt; &#123;</span></span><br><span class="line"><span class="comment">//   console.log(data);</span></span><br><span class="line"><span class="comment">// &#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title class_">Db</span>.<span class="title function_">getInstance</span>();</span><br><span class="line"><span class="comment">// setTimeout(() =&gt; &#123;</span></span><br><span class="line"><span class="comment">//   console.time(&#x27;start1&#x27;);</span></span><br><span class="line"><span class="comment">//   myDb.find(&#x27;user&#x27;, &#123;&#125;).then((data) =&gt; &#123;</span></span><br><span class="line"><span class="comment">//     // console.log(data);</span></span><br><span class="line"><span class="comment">//     console.timeEnd(&#x27;start1&#x27;);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//   &#125;)</span></span><br><span class="line"><span class="comment">// &#125;, 1000);</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// setTimeout(() =&gt; &#123;</span></span><br><span class="line"><span class="comment">//   console.time(&#x27;start2&#x27;);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//   myDb.find(&#x27;user&#x27;, &#123;&#125;).then((data) =&gt; &#123;</span></span><br><span class="line"><span class="comment">//     // console.log(data);</span></span><br><span class="line"><span class="comment">//     console.timeEnd(&#x27;start2&#x27;);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//   &#125;)</span></span><br><span class="line"><span class="comment">// &#125;, 3000);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// setTimeout(() =&gt; &#123;</span></span><br><span class="line"><span class="comment">//   console.time(&#x27;start3&#x27;);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//   myDb.find(&#x27;user&#x27;, &#123;&#125;).then((data) =&gt; &#123;</span></span><br><span class="line"><span class="comment">//     // console.log(data);</span></span><br><span class="line"><span class="comment">//     console.timeEnd(&#x27;start3&#x27;);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//   &#125;)</span></span><br><span class="line"><span class="comment">// &#125;, 5000);</span></span><br></pre></td></tr></table></figure><p>简单的使用：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">.<span class="title function_">get</span>(<span class="string">&#x27;/add&#x27;</span>, <span class="keyword">async</span> (ctx) =&gt; &#123;</span><br><span class="line">   <span class="keyword">let</span> data = <span class="keyword">await</span> <span class="variable constant_">DB</span>.<span class="title function_">insert</span>(<span class="string">&#x27;user&#x27;</span>, &#123;</span><br><span class="line">     <span class="attr">username</span>: <span class="string">&#x27;赵六&#x27;</span>,</span><br><span class="line">     <span class="attr">age</span>: <span class="number">26</span>,</span><br><span class="line">     <span class="attr">sex</span>: <span class="string">&#x27;女&#x27;</span>,</span><br><span class="line">     <span class="attr">status</span>: <span class="string">&#x27;1&#x27;</span></span><br><span class="line">   &#125;)</span><br><span class="line">   <span class="variable language_">console</span>.<span class="title function_">log</span>(data.<span class="property">result</span>);</span><br><span class="line"> &#125;)</span><br><span class="line"> .<span class="title function_">get</span>(<span class="string">&#x27;/edit&#x27;</span>, <span class="keyword">async</span> (ctx) =&gt; &#123;</span><br><span class="line">   <span class="keyword">let</span> data = <span class="keyword">await</span> <span class="variable constant_">DB</span>.<span class="title function_">update</span>(<span class="string">&#x27;user&#x27;</span>,&#123;</span><br><span class="line">     <span class="attr">username</span>: <span class="string">&#x27;张三的小弟&#x27;</span></span><br><span class="line">   &#125;,&#123;</span><br><span class="line">     <span class="attr">username</span>: <span class="string">&#x27;我是祁连山,不是张三他小弟&#x27;</span></span><br><span class="line">   &#125;)</span><br><span class="line">   <span class="variable language_">console</span>.<span class="title function_">log</span>(data.<span class="property">result</span>);</span><br><span class="line"> &#125;)</span><br><span class="line"> .<span class="title function_">get</span>(<span class="string">&#x27;/delete&#x27;</span>, <span class="keyword">async</span> (ctx) =&gt; &#123;</span><br><span class="line">   <span class="keyword">let</span> data = <span class="keyword">await</span> <span class="variable constant_">DB</span>.<span class="title function_">remove</span>(<span class="string">&#x27;user&#x27;</span>,&#123;</span><br><span class="line">     <span class="attr">username</span>: <span class="string">&#x27;张三&#x27;</span></span><br><span class="line">   &#125;)</span><br><span class="line">   <span class="variable language_">console</span>.<span class="title function_">log</span>(data.<span class="property">result</span>);</span><br><span class="line"> &#125;)</span><br></pre></td></tr></table></figure><p>小技巧：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 重定向 执行完某些操作让跳转到哪里</span></span><br><span class="line">ctx.<span class="title function_">redirect</span>(<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line"><span class="comment">// 跳转的时候绑定唯一的 id，下面用的 art-template 模板引擎语法</span></span><br><span class="line">&lt;td&gt;<span class="language-xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/edit?id=&#123;&#123;@$value._id&#125;&#125;&quot;</span>&gt;</span>编辑<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="comment">// 查询 id</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">ObjectID</span> = <span class="built_in">require</span>(<span class="string">&#x27;mongodb&#x27;</span>).<span class="property">ObjectID</span>;</span><br></pre></td></tr></table></figure><h3 id="验证码模块-svgCaptcha"><a href="#验证码模块-svgCaptcha" class="headerlink" title="验证码模块 svgCaptcha"></a>验证码模块 svgCaptcha</h3><p><code>npm install --save svg-captcha</code></p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 使用</span></span><br><span class="line"><span class="keyword">const</span> svgCaptcha = <span class="built_in">require</span>(<span class="string">&#x27;svg-captcha&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> captcha = svgCaptcha.<span class="title function_">create</span>(</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">size</span>: <span class="number">4</span>,</span><br><span class="line">      <span class="attr">fontSize</span>: <span class="number">50</span>,</span><br><span class="line">      <span class="attr">width</span>: <span class="number">120</span>,</span><br><span class="line">      <span class="attr">height</span>: <span class="number">34</span>,</span><br><span class="line">      <span class="attr">background</span>: <span class="string">&quot;#cc9966&quot;</span></span><br><span class="line">    &#125;);</span><br><span class="line">  <span class="comment">// captcha.text 是4位数的验证码</span></span><br><span class="line">  <span class="comment">//console.log(captcha.text);</span></span><br><span class="line"></span><br><span class="line">  ctx.<span class="property">session</span>.<span class="property">code</span> = captcha.<span class="property">text</span>;</span><br><span class="line">  <span class="comment">// 设置它的响应头</span></span><br><span class="line">  ctx.<span class="property">response</span>.<span class="property">type</span> = <span class="string">&#x27;image/svg+xml&#x27;</span>;</span><br><span class="line">  ctx.<span class="property">body</span> = captcha.<span class="property">data</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// mate 五秒跳转</span></span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;refresh&quot;</span> <span class="attr">content</span>=<span class="string">&quot;5; url=&#x27;http://www.qq.com/&#x27;&quot;</span>&gt;</span></span></span><br></pre></td></tr></table></figure><h3 id="利用-koa-jsonp-写-api-接口"><a href="#利用-koa-jsonp-写-api-接口" class="headerlink" title="利用 koa-jsonp 写 api 接口"></a>利用 koa-jsonp 写 api 接口</h3><p><code>npm install koa-jsonp --save</code></p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 引入</span></span><br><span class="line"><span class="keyword">const</span> jsonp = <span class="built_in">require</span>(<span class="string">&#x27;koa-jsonp&#x27;</span>)</span><br><span class="line"><span class="comment">// 配置</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">jsonp</span>())</span><br></pre></td></tr></table></figure></article><div class="trm-reward"><span class="trm-reward-btn trm-glow" onclick='var qr=document.getElementById("qr");qr.style.display="none"===qr.style.display?"block":"none"'><i class="iconfont fas fa-hand-holding-usd"></i></span><p class="trm-reward-comment">我很可爱，请给我钱</p><div id="qr" style="display:none"><div style="display:inline-block"><a rel="noopener" href="https://cheny-chenyu.oss-cn-chengdu.aliyuncs.com/img/weixin-pay.png" target="_blank"><img src="https://cheny-chenyu.oss-cn-chengdu.aliyuncs.com/img/weixin-pay.png" alt="微信" loading="lazy"></a><p>微信</p></div><div style="display:inline-block"><a rel="noopener" href="https://cheny-chenyu.oss-cn-chengdu.aliyuncs.com/img/zhifubao-pay.png" target="_blank"><img src="https://cheny-chenyu.oss-cn-chengdu.aliyuncs.com/img/zhifubao-pay.png" alt="支付宝" loading="lazy"></a><p>支付宝</p></div></div></div><ul class="trm-post-copyright"><li class="trm-post-copyright-author"><strong>本文作者：</strong> Cheny</li><li class="trm-post-copyright-link"><strong>本文链接：</strong> <a id="original-link" href="https://www.yangchenyu.com/koa/" title="Node.js 【Koa】">https://www.yangchenyu.com/koa/</a></li><li class="trm-post-copyright-license"><strong>版权声明：</strong> 本博客所有文章除特别声明外，均默认采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 ">CC BY-NC-SA 4.0</a> 许可协议。</li></ul></div><div id="post-next-prev" class="row"><div class="col-lg-12"><h5 class="trm-title-with-divider">其他文章 <span data-number="02"></span></h5></div><div class="col-lg-6"><div class="trm-blog-card trm-scroll-animation" data-scroll data-scroll-offset="40"><a href="/jsasync/" class="trm-cover-frame trm-anima-link"><img alt="cover" class="no-fancybox" src="https://images.unsplash.com/photo-1515879218367-8466d910aaa4?ixid=Mnw4OTgyNHwwfDF8c2VhcmNofDh8fGNvZGV8ZW58MHx8fHwxNjUwMTI0OTQ2&ixlib=rb-1.2.1&w=750&dpi=2"></a><div class="trm-card-descr"><div class="trm-label trm-category trm-mb-20"><a href="/categories/%E8%BD%AC%E8%BD%BD/">转载</a></div><h5><a href="/jsasync/" class="trm-anima-link">深入理解 JavaScript 事件（ 第1章 ）</a></h5><div class="trm-divider trm-mb-20 trm-mt-20"></div><ul class="trm-card-data trm-label"><li>19/12/28</li><li>10:16</li></ul></div></div></div><div class="col-lg-6"><div class="trm-blog-card trm-scroll-animation" data-scroll data-scroll-offset="40"><a href="/webpack/" class="trm-cover-frame trm-anima-link"><div class="trm-cover-date"><div class="trm-cover-day">20</div><div class="trm-cover-month">2019/11</div></div></a><div class="trm-card-descr"><div class="trm-label trm-category trm-mb-20"><a href="/categories/%E8%AE%B0%E5%BD%95%E7%B1%BB/">记录类</a></div><h5><a href="/webpack/" class="trm-anima-link">解读 webpack 打包后js</a></h5><div class="trm-divider trm-mb-20 trm-mt-20"></div><ul class="trm-card-data trm-label"><li>19/11/20</li><li>10:16</li></ul></div></div></div></div><div class="trm-divider footer-divider"></div><footer class="trm-scroll-animation" data-scroll data-scroll-offset="50"><div class="trm-footer-item"><span>© 2019- 2023</span> <span class="footer-separator" data-separator=" · "></span> <span class="trm-accent-color">Cheny</span></div><div class="trm-footer-item"><span>由 <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> 驱动 v5.4.2 </span><span class="footer-separator" data-separator=" | "></span> <span>主题 - <a rel="noopener" href="https://github.com/MaLuns/hexo-theme-async" target="_blank">Async</a> v1.2.14</span></div><div class="trm-footer-item">博客已萌萌哒运行 <span id="since" class="trm-accent-color"></span> 天</div></footer><script>function show_date_time(){BirthDay=new Date("11/19/2019 17:00:00"),today=new Date,timeold=today.getTime()-BirthDay.getTime(),msPerDay=864e5,day=Math.floor(timeold/msPerDay),since.innerHTML=day}show_date_time()</script></div></div></div></div></div><div class="trm-fixed-container" data-scroll data-scroll-sticky data-scroll-target=".locomotive-scroll__sticky-target" data-scroll-offset="-10"><div class="trm-fixed-btn" data-title="阅读模式" onclick="switchReadMode()"><i class="iconfont fas fa-book-reader"></i></div></div></div></div></div></div><div id="trm-back-top" class="trm-back-top" data-title="回到顶部"><i class="iconfont fas fa-arrow-up"></i></div><div class="trm-search-popup"><div class="trm-search-header"><span class="trm-search-popup-btn-close"><i class="iconfont fas fa-times"></i></span></div><div class="form trm-search-form"><input class="trm-search-input" type="text" placeholder="搜索..."></div><div class="trm-search-result-container"></div></div><script src="https://unpkg.com/swup@2.0.19/dist/swup.min.js"></script><script src="https://unpkg.com/locomotive-scroll@4.1.4/dist/locomotive-scroll.min.js"></script><script src="https://unpkg.com/@fancyapps/ui@4.0/dist/fancybox.umd.js"></script><script src="/js/plugins/typing.js?v=1.2.14"></script><script src="https://unpkg.com/hexo-generator-searchdb@1.4.0/dist/search.js"></script><script src="/js/plugins/local_search.js?v=1.2.14"></script><script src="//code.tidio.co/het7qhit6brc6kwukrbcbtltwr9xhcty.js" async></script><script id="async-script" src="/js/main.js?v=1.2.14"></script></body></html>